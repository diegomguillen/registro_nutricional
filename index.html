<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Nutricional App</title>
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        /* Ocultar scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-checkbox { width: 1.2rem; height: 1.2rem; cursor: pointer; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilo para las tarjetas tipo botón */
        .action-card {
            transition: transform 0.1s, background-color 0.2s;
        }
        .action-card:active {
            transform: scale(0.98);
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <main id="mainContainer" class="flex-1 overflow-y-auto no-scrollbar p-5 pb-24">
        
        <div id="view-home" class="space-y-6 animate-fade-in">
            <header class="flex items-center gap-3 mb-2">
				<img src="icon.png" class="w-12 h-12 rounded-xl shadow-sm bg-white p-1" alt="Logo App">
    
			<div>
				<h1 class="text-2xl font-bold text-slate-900 leading-tight">Diario nutricional</h1>
				<p class="text-slate-500 text-sm">Añade tus comidas de hoy</p>
			</div>
			</header>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Fecha</label>
                        <input type="date" id="entryDate" class="w-full rounded-xl border-slate-200 bg-slate-50 focus:border-indigo-500 focus:ring-indigo-200 p-3 text-sm font-medium">
                    </div>

                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <label class="block text-xs font-bold text-blue-700 uppercase mb-1">Buscar Online</label>
                        <div class="flex gap-2">
                            <input type="text" id="apiSearchInput" placeholder="Ej: Manzana..." class="w-full bg-white rounded-lg border-blue-200 text-sm p-2 focus:border-blue-500 focus:outline-none" onkeypress="handleEnter(event)">
                            <button onclick="searchOnline()" class="bg-blue-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-sm active:bg-blue-700">
                                <svg id="searchIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <div id="searchLoader" class="loader hidden"></div>
                            </button>
                        </div>
                        <div id="searchResults" class="hidden mt-2 max-h-40 overflow-y-auto bg-white border border-blue-100 rounded-lg shadow-sm text-xs z-10 relative"></div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Alimento</label>
                        <select id="foodSelect" class="w-full rounded-xl border-slate-200 bg-white shadow-sm p-3 text-sm appearance-none focus:border-indigo-500 focus:ring-indigo-200"></select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5" id="amountLabel">Cantidad (g)</label>
                        <input type="number" id="amountInput" class="w-full rounded-xl border-slate-200 bg-slate-50 p-3 text-sm font-medium focus:border-indigo-500 focus:ring-indigo-200" placeholder="100" value="100">
                    </div>

                    <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                         <div id="previewData" class="text-sm"></div>
                    </div>

                    <button onclick="addItem()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-md shadow-indigo-200 active:transform active:scale-95 transition-all text-sm">
                        Añadir Registro
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                <h3 class="text-sm font-semibold text-slate-700 mb-4 text-center">Distribución calórica</h3>
                <div class="h-48 relative w-full flex justify-center">
                    <canvas id="macroChart"></canvas>
                </div>
                <div class="grid grid-cols-4 gap-2 mt-4 text-center">
                    <div class="bg-green-50 rounded-lg p-2"><div class="text-[10px] text-red-600 font-bold">PROT</div><div id="homeProt" class="text-xs font-bold text-slate-700">0g</div></div>
                    <div class="bg-yellow-50 rounded-lg p-2"><div class="text-[10px] text-yellow-600 font-bold">CARB</div><div id="homeCarbs" class="text-xs font-bold text-slate-700">0g</div></div>
                    <div class="bg-red-50 rounded-lg p-2"><div class="text-[10px] text-orange-600 font-bold">GRAS</div><div id="homeFats" class="text-xs font-bold text-slate-700">0g</div></div>
                    <div class="bg-green-50 rounded-lg p-2"><div class="text-[10px] text-green-600 font-bold">KCAL</div><div id="homeKcal" class="text-xs font-bold text-slate-700">0</div></div>
                </div>
            </div>
        </div>

        <div id="view-history" class="space-y-6 hidden animate-fade-in">
            <header>
                <h1 class="text-2xl font-bold text-slate-900">Historial</h1>
                <p class="text-slate-500 text-sm">Consulta y filtra tus registros</p>
            </header>

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-3">
                <div class="flex gap-2 text-sm">
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Desde</label>
                        <input type="date" id="filterStart" onchange="updateDayLabels(); applyFilter()" class="w-full rounded-lg border-slate-200 text-xs p-2">
                        <div id="labelStart" class="text-[10px] text-indigo-500 mt-1 font-medium h-3"></div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Hasta</label>
                        <input type="date" id="filterEnd" onchange="updateDayLabels(); applyFilter()" class="w-full rounded-lg border-slate-200 text-xs p-2">
                        <div id="labelEnd" class="text-[10px] text-indigo-500 mt-1 font-medium h-3 text-right"></div>
                    </div>
                </div>
                <div class="flex justify-between gap-2 pt-2 border-t border-slate-50">
                    <button onclick="shiftDate(-1)" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold flex-1">-1 Día</button>
                    <button onclick="setTodayFilter()" class="bg-indigo-50 text-indigo-600 px-3 py-2 rounded-lg text-xs font-bold flex-1">Hoy</button>
                    <button onclick="shiftDate(1)" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold flex-1">+1 Día</button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-100">
                        <thead class="bg-slate-50 text-slate-500">
                            <tr>
                                <th class="px-4 py-3 w-8"><input type="checkbox" onclick="toggleAll(this)" class="custom-checkbox rounded text-indigo-600"></th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase">Alimento</th>
                                <th class="px-4 py-3 text-right text-xs font-bold uppercase">Kcal</th>
                                <th class="px-4 py-3"></th>
                            </tr>
                        </thead>
                        <tbody id="foodTableBody" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                </div>
                <div class="bg-slate-50 p-3 border-t border-slate-100 flex justify-between items-center text-sm">
                    <span class="font-bold text-slate-500 uppercase text-xs">Total Vista:</span>
                    <span class="font-bold text-slate-900 text-base" id="footKcal">0 <span class="text-xs font-normal text-slate-500">kcal</span></span>
                </div>
            </div>
        </div>

        <div id="view-backup" class="space-y-6 hidden animate-fade-in">
            <header>
                <h1 class="text-2xl font-bold text-slate-900">Datos</h1>
                <p class="text-slate-500 text-sm">Gestiona copias de seguridad</p>
            </header>

            <div class="space-y-4">
                
                <div onclick="exportData()" class="action-card bg-white rounded-2xl p-4 border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-slate-800">Exportar copia</h3>
                        <p class="text-xs text-slate-500">Guardar o compartir backup JSON</p>
                    </div>
                    <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>

                <div onclick="document.getElementById('importFile').click()" class="action-card bg-white rounded-2xl p-4 border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-slate-800">Importar copia</h3>
                        <p class="text-xs text-slate-500">Restaurar datos desde archivo</p>
                    </div>
                    <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImport(this)">

                <div onclick="resetApp()" class="action-card bg-white rounded-2xl p-4 border border-slate-100 shadow-sm flex items-center gap-4 cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center text-red-500 flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-red-600">Borrar todo</h3>
                        <p class="text-xs text-red-300">Eliminar historial localmente</p>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 h-16 flex justify-around items-center z-40 pb-safe">
        <button onclick="switchView('home')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-indigo-600" id="btn-home">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-[10px] font-bold">Registro</span>
        </button>
        
        <button onclick="switchView('history')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400" id="btn-history">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            <span class="text-[10px] font-bold">Historial</span>
        </button>
        
        <button onclick="switchView('backup')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400" id="btn-backup">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
            <span class="text-[10px] font-bold">Datos</span>
        </button>
    </nav>

    <div id="analyzeFab" class="fixed bottom-20 right-5 hidden z-50 animate-bounce-in">
        <button onclick="analyzeSelection()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg shadow-indigo-300 flex items-center gap-2 transition-transform active:scale-95">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
            <span id="fabText">Analizar</span>
        </button>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl overflow-hidden shadow-2xl animate-slide-up sm:animate-fade-in">
            <div class="bg-slate-50 px-5 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">Análisis</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 bg-white rounded-full p-1 border"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-3 gap-2 mb-6 text-center">
                    <div class="p-2 bg-green-50 rounded-xl border border-red-100"><div class="text-[10px] text-red-600 font-bold uppercase">Prot</div><div class="text-lg font-bold text-slate-800"><span id="modalP">0</span>g</div></div>
                    <div class="p-2 bg-yellow-50 rounded-xl border border-yellow-100"><div class="text-[10px] text-yellow-600 font-bold uppercase">Carbs</div><div class="text-lg font-bold text-slate-800"><span id="modalC">0</span>g</div></div>
                    <div class="p-2 bg-red-50 rounded-xl border border-orange-100"><div class="text-[10px] text-orange-600 font-bold uppercase">Grasas</div><div class="text-lg font-bold text-slate-800"><span id="modalF">0</span>g</div></div>
                </div>
                <div class="text-center mb-6"><span class="text-3xl font-black text-slate-900" id="modalKcal">0</span><span class="text-sm text-slate-500 font-medium ml-1">kcal</span></div>
                <div class="h-40 relative w-full flex justify-center mb-4"><canvas id="modalChart"></canvas></div>
                <div class="border-t border-slate-100 pt-4"><h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Elementos</h4><ul id="modalList" class="text-sm text-slate-600 space-y-2 max-h-32 overflow-y-auto"></ul></div>
            </div>
            <div class="p-4 bg-slate-50"><button onclick="closeModal()" class="w-full bg-slate-200 text-slate-700 font-bold py-3 rounded-xl">Cerrar</button></div>
        </div>
    </div>

    <script>
        // --- GESTIÓN DE VISTAS (TAB NAVIGATION) ---
        function switchView(viewName) {
            // Ocultar todas las vistas
            ['home', 'history', 'backup'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            // Mostrar la seleccionada
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Actualizar botones Nav
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-indigo-600');
                btn.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById(`btn-${viewName}`);
            activeBtn.classList.remove('text-slate-400');
            activeBtn.classList.add('text-indigo-600');

            // Scroll al top
            document.getElementById('mainContainer').scrollTop = 0;
            
            // Refrescar datos si es necesario
            if(viewName === 'history' || viewName === 'home') applyFilter();
        }

        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Fail', err)); }); }

        // --- DATA INICIAL Y LÓGICA (MISMAS FUNCIONES, SOLO UI ACTUALIZADA) ---
        let foodData = [
            { id: 1,  name: "Suplementos (Whey/Caseína)", p: 86.0, c: 3.0, f: 2.0, kcal: 375, unit: "g" },
            { id: 2,  name: "Aceites Puros (AOVE)", p: 0.0, c: 0.0, f: 100.0, kcal: 900, unit: "g" },
            { id: 3,  name: "Grasas Vegetales (Aguacate)", p: 1.5, c: 4.0, f: 17.0, kcal: 175, unit: "g" },
            { id: 4,  name: "Frutos Secos y Semillas", p: 20.0, c: 16.0, f: 48.0, kcal: 575, unit: "g" },
            { id: 5,  name: "Carnes Magras (Pollo/Pavo)", p: 21.0, c: 0.5, f: 3.5, kcal: 117, unit: "g" },
            { id: 6,  name: "Carnes Rojas / Procesadas", p: 20.0, c: 0.5, f: 5.5, kcal: 130, unit: "g" },
            { id: 7,  name: "Lácteos Quesos Curados", p: 20.5, c: 0.5, f: 26.5, kcal: 325, unit: "g" },
            { id: 8,  name: "Lácteos semidesnatados", p: 4.0, c: 5.1, f: 1.8, kcal: 53, unit: "g" },
            { id: 9,  name: "Lácteos Frescos (Yogur)", p: 6.5, c: 4.0, f: 3.0, kcal: 69, unit: "g" },
            { id: 10, name: "Pescado Blanco y Mariscos", p: 19.5, c: 0.5, f: 2.0, kcal: 100, unit: "g" },
            { id: 11, name: "Pescado Azul / Conservas", p: 19.5, c: 0.5, f: 11.5, kcal: 180, unit: "g" },
            { id: 12, name: "Huevo (Unidad ~60g)", p: 6.5, c: 1.0, f: 7.5, kcal: 98, unit: "u" },   
            { id: 13, name: "Harinas y Cereales (Crudo)", p: 12.5, c: 63.0, f: 5.5, kcal: 350, unit: "g" },
            { id: 14, name: "Panes", p: 9.5, c: 47.5, f: 2.5, kcal: 250, unit: "g" },
            { id: 15, name: "Hidratos Cocidos (Pasta)", p: 4.0, c: 25.0, f: 0.5, kcal: 120, unit: "g" },
            { id: 16, name: "Frutas Frescas", p: 0.5, c: 12.0, f: 0.5, kcal: 55, unit: "g" },
            { id: 17, name: "Verduras y Hortalizas", p: 1.5, c: 6.0, f: 0.5, kcal: 35, unit: "g" },
            { id: 18, name: "Legumbres", p: 6.0, c: 12.0, f: 0.8, kcal: 79, unit: "g" },
            { id: 19, name: "Macro proteina", p: 100.0, c: 0.0, f: 0.0, kcal: 400, unit: "g" },
            { id: 20, name: "Macro carbohidrato", p: 0.0, c: 100.0, f: 0.0, kcal: 400, unit: "g" },
            { id: 21, name: "Macro grasa", p: 0.0, c: 0.0, f: 100.0, kcal: 900, unit: "g" },
            { id: 22, name: "Ñoquis (Gnocchi)", p: 3.5, c: 36.0, f: 0.5, kcal: 165, unit: "g" },
            { id: 23, name: "Tubérculos (Patata/Batata)", p: 2, c: 21.0, f: 0.2, kcal: 94, unit: "g" },
            // Propuestas Micro-unidades
            { id: 24, name: "Aceituna (Unidad ~4g)", p: 0.0, c: 0.0, f: 0.5, kcal: 6, unit: "u" },
            { id: 25, name: "Nuez (Grano ~5g)", p: 0.8, c: 0.7, f: 3.0, kcal: 33, unit: "u" },
            { id: 26, name: "Tomate Cherry (Unidad ~12g)", p: 0.1, c: 0.5, f: 0.0, kcal: 3, unit: "u" },
            // Propuestas Macro-unidades
            { id: 27, name: "Tomate Ensalada (Unidad ~150g)", p: 1.5, c: 5.5, f: 0.3, kcal: 30, unit: "u" },
            { id: 28, name: "Manzana (Media ~180g)", p: 0.5, c: 25.0, f: 0.5, kcal: 95, unit: "u" },
            // otros
            { id: 29, name: "Jamón Serrano", p: 33.5, c: 1.0, f: 12.2, kcal: 248, unit: "g" }
        ];

        let globalLog = []; 
        let chartInstance = null;
        let modalChartInstance = null;
        let selectedIds = new Set();

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            populateSelect();
            initDateInputs();
            document.getElementById('foodSelect').addEventListener('change', updatePreview);
            document.getElementById('amountInput').addEventListener('input', updatePreview); 
            setTodayFilter(); 
            updatePreview();
            updateDayLabels();
            
            // Animación inicial
            switchView('home');
        });

        function updatePreview() {
            const select = document.getElementById('foodSelect');
            const amountInput = document.getElementById('amountInput'); 
            const foodId = parseInt(select.value);
            const food = foodData.find(f => f.id === foodId);
            
            if (food) {
                document.getElementById('amountLabel').textContent = food.unit === 'u' ? "Cantidad (unidades)" : "Cantidad (gramos)";
                const amount = parseFloat(amountInput.value) || 0; 
                const factor = food.unit === 'g' ? amount / 100 : amount;
                const p = (food.p * factor).toFixed(1);
                const c = (food.c * factor).toFixed(1);
                const f = (food.f * factor).toFixed(1);
                const k = Math.round(food.kcal * factor);

                document.getElementById('previewData').innerHTML = `
                    <div class="flex justify-between items-center text-slate-700">
                        <div class="flex flex-col text-center w-1/4 border-r border-slate-200 last:border-0">
                            <span class="text-[10px] font-bold text-green-500 uppercase">Prot</span>
                            <span class="font-mono font-bold">${p}</span>
                        </div>
                        <div class="flex flex-col text-center w-1/4 border-r border-slate-200 last:border-0">
                            <span class="text-[10px] font-bold text-yellow-500 uppercase">Carb</span>
                            <span class="font-mono font-bold">${c}</span>
                        </div>
                        <div class="flex flex-col text-center w-1/4 border-r border-slate-200 last:border-0">
                            <span class="text-[10px] font-bold text-red-500 uppercase">Gras</span>
                            <span class="font-mono font-bold">${f}</span>
                        </div>
                        <div class="flex flex-col text-center w-1/4">
                            <span class="text-[10px] font-bold text-green-600 uppercase">Kcal</span>
                            <span class="font-bold text-green-700">${k}</span>
                        </div>
                    </div>
                `;
            }
        }

        // BÚSQUEDA API
        function handleEnter(e) { if(e.key === 'Enter') searchOnline(); }
        async function searchOnline() {
            const query = document.getElementById('apiSearchInput').value;
            if(!query || query.length < 3) return alert("Escribe al menos 3 caracteres.");
            const loader = document.getElementById('searchLoader');
            const icon = document.getElementById('searchIcon');
            const resultsDiv = document.getElementById('searchResults');
            
            loader.classList.remove('hidden'); icon.classList.add('hidden');
            resultsDiv.classList.add('hidden'); resultsDiv.innerHTML = '';

            try {
                const url = `https://es.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&fields=product_name,nutriments,id`;
                const response = await fetch(url);
                const data = await response.json();

                if(data.products && data.products.length > 0) {
                    let html = '<ul class="divide-y divide-blue-50">';
                    let found = false;
                    data.products.forEach(prod => {
                        if(prod.nutriments && (prod.nutriments['energy-kcal_100g'] !== undefined || prod.nutriments['energy-kcal'] !== undefined)) {
                            found = true;
                            const p = prod.nutriments['proteins_100g'] || 0;
                            const c = prod.nutriments['carbohydrates_100g'] || 0;
                            const f = prod.nutriments['fat_100g'] || 0;
                            const k = prod.nutriments['energy-kcal_100g'] || prod.nutriments['energy-kcal'] || 0;
                            const safeName = (prod.product_name || "Sin nombre").replace(/'/g, "");
                            html += `<li class="p-3 hover:bg-blue-50 cursor-pointer flex justify-between items-center group transition-colors" onclick="selectApiItem('${safeName}', ${p}, ${c}, ${f}, ${k})"><span class="font-medium text-slate-700 truncate w-3/4">${prod.product_name}</span><span class="text-blue-500 text-xs font-bold bg-blue-50 px-2 py-1 rounded-md">${Math.round(k)}</span></li>`;
                        }
                    });
                    if(!found) html += '<li class="p-3 text-slate-400 italic text-xs">Sin info válida.</li>';
                    html += '</ul>';
                    resultsDiv.innerHTML = html; resultsDiv.classList.remove('hidden');
                } else { alert("Sin resultados."); }
            } catch (error) { console.error(error); alert("Error de conexión."); } finally { loader.classList.add('hidden'); icon.classList.remove('hidden'); }
        }

        function selectApiItem(name, p, c, f, kcal) {
            const newId = 1000 + foodData.length + Math.floor(Math.random() * 1000);
            foodData.push({ id: newId, name: `[WEB] ${name}`, p: Number(p), c: Number(c), f: Number(f), kcal: Number(kcal), unit: 'g' });
            populateSelect();
            document.getElementById('foodSelect').value = newId;
            updatePreview();
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('apiSearchInput').value = '';
        }

        // UTILS
        function initDateInputs() { document.getElementById('entryDate').value = new Date().toISOString().split('T')[0]; }
        function setTodayFilter() { const t = new Date().toISOString().split('T')[0]; document.getElementById('filterStart').value = t; document.getElementById('filterEnd').value = t; updateDayLabels(); applyFilter(); }
        function shiftDate(d) {
            const s = document.getElementById('filterStart').value, e = document.getElementById('filterEnd').value;
            if(!s) return;
            const add = (str, n) => { const dt = new Date(str); dt.setDate(dt.getDate()+n); return dt.toISOString().split('T')[0]; };
            document.getElementById('filterStart').value = add(s,d);
            document.getElementById('filterEnd').value = e ? add(e,d) : add(s,d);
            updateDayLabels(); applyFilter();
        }
        function updateDayLabels() {
            const d = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
            const l = (v) => v ? d[new Date(v).getDay()]+' '+new Date(v).getDate() : '';
            document.getElementById('labelStart').textContent = l(document.getElementById('filterStart').value);
            document.getElementById('labelEnd').textContent = l(document.getElementById('filterEnd').value);
        }
        function populateSelect() {
            const sel = document.getElementById('foodSelect');
            const val = sel.value; sel.innerHTML = '';
            [...foodData].sort((a,b)=>a.name.localeCompare(b.name)).forEach(f => {
                const o = document.createElement('option'); o.value = f.id; o.text = f.name; sel.appendChild(o);
            });
            if(val && [...sel.options].some(o => o.value == val)) sel.value = val;
        }

        // CRUD
        function addItem() {
            const select = document.getElementById('foodSelect');
            const amountInput = document.getElementById('amountInput');
            const dateInput = document.getElementById('entryDate');
            const amount = parseFloat(amountInput.value);
            const foodId = parseInt(select.value);
            
            if (!amount || amount <= 0 || !dateInput.value) return alert("Revise datos.");

            const food = foodData.find(f => f.id === foodId);
            const factor = food.unit === 'g' ? amount / 100 : amount;

            globalLog.push({
                id: Date.now(),
                date: dateInput.value,
                foodId: food.id,
                foodName: food.name,
                amount: amount,
                unit: food.unit,
                p: parseFloat((food.p * factor).toFixed(1)),
                c: parseFloat((food.c * factor).toFixed(1)),
                f: parseFloat((food.f * factor).toFixed(1)),
                kcal: Math.round(food.kcal * factor)
            });
            saveData(); 
            applyFilter();
            alert("Guardado!");
        }

        function deleteItem(id) { if(confirm('¿Borrar?')) { globalLog = globalLog.filter(i => i.id !== id); selectedIds.delete(id); saveData(); applyFilter(); } }
        function resetApp() { if(confirm('¿BORRAR TODO?')) { localStorage.removeItem('macroCalculatorData'); globalLog = []; selectedIds.clear(); applyFilter(); } }

        // EXPORT/IMPORT
        async function exportData() {
            if(!globalLog.length) return alert("Sin datos.");
            const f = new File([JSON.stringify(globalLog,null,2)], `backup_${new Date().toISOString().split('T')[0]}.json`, {type:"application/json"});
            if(navigator.canShare && navigator.canShare({files:[f]})) { try { await navigator.share({files:[f], title:'Backup Nutri'}); return; } catch(e){} }
            const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(globalLog,null,2)], {type:"application/json"})); a.download=f.name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function handleImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(Array.isArray(d) && confirm(`¿Importar ${d.length} registros?`)) { globalLog = d; saveData(); applyFilter(); alert("Hecho."); } } catch(err){ alert("Error archivo."); } input.value=''; }; r.readAsText(f);
        }
        function saveData() { localStorage.setItem('macroCalculatorData', JSON.stringify(globalLog)); }
        function loadData() { const s = localStorage.getItem('macroCalculatorData'); if(s) globalLog = JSON.parse(s); }

        // MODAL & SELECCION
        function toggleSelection(id) { selectedIds.has(id) ? selectedIds.delete(id) : selectedIds.add(id); updateFab(); }
        function toggleAll(src) { document.querySelectorAll('.row-checkbox').forEach(c => { c.checked = src.checked; const id = parseInt(c.dataset.id); src.checked ? selectedIds.add(id) : selectedIds.delete(id); }); updateFab(); }
        function updateFab() {
            const fab = document.getElementById('analyzeFab');
            if(selectedIds.size > 0) { fab.classList.remove('hidden'); fab.classList.add('flex'); document.getElementById('fabText').textContent = `Analizar (${selectedIds.size})`; }
            else { fab.classList.add('hidden'); fab.classList.remove('flex'); }
        }
        function analyzeSelection() {
            const items = globalLog.filter(i => selectedIds.has(i.id));
            if (!items.length) return;
            let p=0, c=0, f=0, k=0;
            const list = document.getElementById('modalList'); list.innerHTML='';
            items.forEach(i => {
                p+=i.p; c+=i.c; f+=i.f; k+=i.kcal;
                list.innerHTML += `<li class="flex justify-between border-b border-slate-50 pb-2 last:border-0"><span>${i.foodName}</span><span class="text-xs text-slate-400 font-mono bg-slate-50 px-1 rounded">${i.amount}${i.unit}</span></li>`;
            });
            document.getElementById('modalP').textContent=p.toFixed(1);
            document.getElementById('modalC').textContent=c.toFixed(1);
            document.getElementById('modalF').textContent=f.toFixed(1);
            document.getElementById('modalKcal').textContent=k;
            const ctx = document.getElementById('modalChart').getContext('2d');
            if(modalChartInstance) modalChartInstance.destroy();
            const hasD = (p+c+f)>0;
            modalChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Prot','Carbs','Grasas'], datasets: [{ data: hasD?[p*4,c*4,f*9]:[1,1,1], backgroundColor: hasD?['#39f792','#eab308','#ef4444']:['#eee','#eee','#eee'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{position:'bottom'}} } });
            document.getElementById('detailModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }

        // RENDER & CALC
        function applyFilter() {
            const s = document.getElementById('filterStart').value, e = document.getElementById('filterEnd').value;
            let f = globalLog.sort((a,b)=>b.id-a.id);
            if(s && e) f = f.filter(i => i.date >= s && i.date <= e);
            selectedIds.clear(); updateFab(); renderTable(f); calcTotals(f);
        }
        function renderTable(items) {
            const tb = document.getElementById('foodTableBody'); tb.innerHTML='';
            if(!items.length) { tb.innerHTML='<tr><td colspan="4" class="p-8 text-center text-slate-400 italic text-sm">Sin registros</td></tr>'; return; }
            items.forEach(i => {
                const ck = selectedIds.has(i.id)?'checked':'';
                // Tabla simplificada para móvil
                tb.innerHTML += `
                <tr class="hover:bg-slate-50 group transition-colors">
                    <td class="px-4 py-3 text-center"><input type="checkbox" data-id="${i.id}" class="row-checkbox custom-checkbox rounded text-indigo-600" onclick="toggleSelection(${i.id})" ${ck}></td>
                    <td class="px-4 py-3">
                        <div class="font-bold text-slate-800">${i.foodName}</div>
                        <div class="text-xs text-slate-400">${i.date} &bull; ${i.amount}${i.unit}</div>
                    </td>
                    <td class="px-4 py-3 text-right font-bold text-slate-700">${i.kcal}</td>
                    <td class="px-4 py-3 text-center"><button onclick="deleteItem(${i.id})" class="text-red-300 hover:text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td>
                </tr>`;
            });
        }
        function calcTotals(items) {
            let p=0, c=0, f=0, k=0; items.forEach(i => { p+=i.p; c+=i.c; f+=i.f; k+=i.kcal; });
            
            // Actualizar mini-labels en HOME
            if(document.getElementById('homeProt')) {
                document.getElementById('homeProt').textContent = p.toFixed(0)+'g';
                document.getElementById('homeCarbs').textContent = c.toFixed(0)+'g';
                document.getElementById('homeFats').textContent = f.toFixed(0)+'g';
                document.getElementById('homeKcal').textContent = k;
            }
            // Actualizar footer en HISTORY
            if(document.getElementById('footKcal')) {
                document.getElementById('footKcal').innerHTML = `${k} <span class="text-xs font-normal text-slate-500">kcal</span>`;
            }

            const ctx = document.getElementById('macroChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
            const h = (p+c+f)>0; chartInstance = new Chart(ctx, { type:'doughnut', data:{ labels:['Prot','Carbs','Grasas'], datasets:[{data:h?[p*4,c*4,f*9]:[1,1,1], backgroundColor:h?['#39f792','#eab308','#ef4444']:['#f1f5f9','#f1f5f9','#f1f5f9'], borderWidth:0}] }, options:{responsive:true, maintainAspectRatio:false, cutout:'75%', plugins:{legend:{position:'bottom', labels:{boxWidth:10, font:{size:10}}}}} });
        }
    </script>
</body>

</html>
