<!DOCTYPE html>
<html lang="es">
   
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Nutricional Pro (Dinámico)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        tfoot { font-weight: bold; background-color: #e5e7eb; }
        .custom-checkbox { width: 1.2rem; height: 1.2rem; cursor: pointer; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icon.png">     
</head>
<body class="text-gray-800 relative">

    <div class="max-w-6xl mx-auto p-4 md:p-8 pb-24">
        
        <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Registro Nutricional</h1>
                <p class="text-gray-600 text-sm">Cálculo dinámico + API Online</p>
            </div>
            
            <div class="flex flex-wrap gap-3 items-center">
                <input type="file" id="importFile" accept=".json" class="hidden" onchange="handleImport(this)">
                <button onclick="exportData()" class="flex items-center gap-1 bg-blue-100 text-blue-700 px-3 py-1.5 rounded text-xs font-bold hover:bg-blue-200 transition-colors">Exportar</button>
                <button onclick="document.getElementById('importFile').click()" class="flex items-center gap-1 bg-green-100 text-green-700 px-3 py-1.5 rounded text-xs font-bold hover:bg-green-200 transition-colors">Importar</button>
                <div class="h-4 w-px bg-gray-300 mx-1"></div>
                <button onclick="resetApp()" class="text-xs text-red-500 hover:text-red-700 underline">Borrar Todo</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-4 xl:col-span-3 space-y-6">
                <div class="bg-white rounded-xl shadow-md p-5 border-t-4 border-blue-600">
                    <h2 class="text-lg font-semibold mb-4 text-gray-800">Nueva Entrada</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fecha</label>
                            <input type="date" id="entryDate" class="w-full rounded border-gray-300 bg-gray-50 shadow-sm focus:border-blue-500 p-2 border text-sm">
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Buscar en Web</label>
                            <div class="flex gap-2">
                                <input type="text" id="apiSearchInput" placeholder="Ej: Galletas Oreo" class="w-full rounded border-gray-300 text-sm p-1.5 border focus:border-blue-500" onkeypress="handleEnter(event)">
                                <button onclick="searchOnline()" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700 flex items-center justify-center min-w-[40px]">
                                    <svg id="searchIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    <div id="searchLoader" class="loader hidden"></div>
                                </button>
                            </div>
                            <div id="searchResults" class="hidden mt-2 max-h-40 overflow-y-auto bg-white border border-gray-200 rounded shadow-sm text-xs"></div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Alimento</label>
                            <select id="foodSelect" class="w-full rounded border-gray-300 shadow-sm focus:border-blue-500 p-2 border bg-white text-sm"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="amountLabel">Cantidad (g)</label>
                            <input type="number" id="amountInput" class="w-full rounded border-gray-300 shadow-sm focus:border-blue-500 p-2 border text-sm" placeholder="Ej: 100" value="100">
                        </div>
                        <button onclick="addItem()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-sm text-sm">Guardar Registro</button>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-100 bg-gray-50 rounded p-2">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-1">Cálculo para la cantidad actual:</h3>
                        <div id="previewData" class="text-sm text-gray-700"></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2 text-center">Resumen (Vista Actual)</h3>
                    <div class="h-48 relative w-full flex justify-center">
                        <canvas id="macroChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 xl:col-span-9 space-y-6">
                <div class="bg-white p-4 rounded-xl shadow-md space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 font-bold uppercase mb-1">Desde</label>
                            <input type="date" id="filterStart" onchange="updateDayLabels()" class="w-full rounded border-gray-300 text-sm p-2 border shadow-sm">
                            <div id="labelStart" class="text-xs text-blue-600 mt-1 font-medium h-4"></div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 font-bold uppercase mb-1">Hasta</label>
                            <input type="date" id="filterEnd" onchange="updateDayLabels()" class="w-full rounded border-gray-300 text-sm p-2 border shadow-sm">
                            <div id="labelEnd" class="text-xs text-blue-600 mt-1 font-medium h-4 text-right"></div>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 border-t pt-3">
                        <div class="flex gap-2 w-full sm:w-auto justify-center sm:justify-start">
                            <button onclick="shiftDate(-1)" class="bg-gray-100 text-gray-700 px-3 py-2 rounded text-xs font-bold hover:bg-gray-200 border flex items-center gap-1">-1 Día</button>
                            <button onclick="shiftDate(1)" class="bg-gray-100 text-gray-700 px-3 py-2 rounded text-xs font-bold hover:bg-gray-200 border flex items-center gap-1">+1 Día</button>
                            <button onclick="shiftDate(-7)" class="bg-indigo-50 text-indigo-700 px-3 py-2 rounded text-xs font-bold hover:bg-indigo-100 border border-indigo-200">-7 Días</button>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto justify-center sm:justify-end">
                            <button onclick="setTodayFilter()" class="bg-green-50 text-green-700 px-4 py-2 rounded text-xs font-bold hover:bg-green-100 border border-green-200">HOY</button>
                            <button onclick="applyFilter()" class="bg-gray-900 text-white px-6 py-2 rounded text-xs font-bold hover:bg-gray-800 shadow-md transform active:scale-95">FILTRAR</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white p-3 rounded-lg shadow border-l-4 border-red-500">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Proteínas</div>
                        <div class="text-xl font-bold text-gray-800"><span id="summaryProtein">0</span><span class="text-xs font-normal text-gray-500 ml-1">g</span></div>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow border-l-4 border-yellow-400">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Carbohidratos</div>
                        <div class="text-xl font-bold text-gray-800"><span id="summaryCarbs">0</span><span class="text-xs font-normal text-gray-500 ml-1">g</span></div>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow border-l-4 border-orange-400">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Grasas</div>
                        <div class="text-xl font-bold text-gray-800"><span id="summaryFats">0</span><span class="text-xs font-normal text-gray-500 ml-1">g</span></div>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow border-l-4 border-green-600">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">Energía</div>
                        <div class="text-xl font-bold text-gray-800"><span id="summaryKcal">0</span><span class="text-xs font-normal text-gray-500 ml-1">kcal</span></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-4 py-3 w-10 text-center"><input type="checkbox" onclick="toggleAll(this)" class="custom-checkbox rounded text-blue-600"></th>
                                    <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Fecha</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Alimento</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Cant.</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Prot.</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Carbs.</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Grasas</th>
                                    <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Kcal</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="foodTableBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            <tfoot id="tableFooter" class="bg-gray-100 text-sm border-t-2 border-gray-300">
                                <tr>
                                    <td></td>
                                    <td colspan="3" class="px-4 py-3 text-right font-bold text-gray-600 uppercase">Total Vista:</td>
                                    <td class="px-4 py-3 text-right font-bold text-gray-900" id="footProtein">0.0</td>
                                    <td class="px-4 py-3 text-right font-bold text-gray-900" id="footCarbs">0.0</td>
                                    <td class="px-4 py-3 text-right font-bold text-gray-900" id="footFats">0.0</td>
                                    <td class="px-4 py-3 text-right font-bold text-gray-900" id="footKcal">0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="analyzeFab" class="fixed bottom-6 right-6 hidden z-40">
            <button onclick="analyzeSelection()" class="bg-gray-900 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full shadow-2xl flex items-center gap-2 transform hover:scale-105 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                <span id="fabText">Analizar (0)</span>
            </button>
        </div>

        <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-800">Análisis de Selección</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-3 gap-2 mb-6 text-center">
                        <div class="p-2 bg-red-50 rounded-lg border border-red-100"><div class="text-xs text-red-600 font-bold uppercase">Prot</div><div class="text-lg font-bold text-gray-800"><span id="modalP">0</span>g</div></div>
                        <div class="p-2 bg-yellow-50 rounded-lg border border-yellow-100"><div class="text-xs text-yellow-600 font-bold uppercase">Carbs</div><div class="text-lg font-bold text-gray-800"><span id="modalC">0</span>g</div></div>
                        <div class="p-2 bg-orange-50 rounded-lg border border-orange-100"><div class="text-xs text-orange-600 font-bold uppercase">Grasas</div><div class="text-lg font-bold text-gray-800"><span id="modalF">0</span>g</div></div>
                    </div>
                    <div class="text-center mb-6"><span class="text-3xl font-black text-gray-900" id="modalKcal">0</span><span class="text-sm text-gray-500 font-medium uppercase ml-1">kcal totales</span></div>
                    <div class="h-48 relative w-full flex justify-center mb-4"><canvas id="modalChart"></canvas></div>
                    <div class="border-t pt-4"><h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Elementos incluidos:</h4><ul id="modalList" class="text-sm text-gray-600 space-y-1 max-h-32 overflow-y-auto"></ul></div>
                </div>
                <div class="bg-gray-50 px-6 py-3 text-right"><button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">Cerrar</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA INICIAL ---
        let foodData = [
            { id: 1,  name: "Suplementos (Whey/Caseína)", p: 86.0, c: 3.0, f: 2.0, kcal: 375, unit: "g" },
            { id: 2,  name: "Aceites Puros (AOVE)", p: 0.0, c: 0.0, f: 100.0, kcal: 900, unit: "g" },
            { id: 3,  name: "Grasas Vegetales (Aguacate)", p: 1.5, c: 4.0, f: 17.0, kcal: 175, unit: "g" },
            { id: 4,  name: "Frutos Secos y Semillas", p: 20.0, c: 16.0, f: 48.0, kcal: 575, unit: "g" },
            { id: 5,  name: "Carnes Magras (Pollo/Pavo)", p: 21.0, c: 0.5, f: 3.5, kcal: 117, unit: "g" },
            { id: 6,  name: "Carnes Rojas / Procesadas", p: 20.0, c: 0.5, f: 5.5, kcal: 130, unit: "g" },
            { id: 7,  name: "Lácteos Quesos Curados", p: 20.5, c: 0.5, f: 26.5, kcal: 325, unit: "g" },
            { id: 8,  name: "Lácteos semidesnatados", p: 4.0, c: 5.1, f: 1.8, kcal: 53, unit: "g" },
            { id: 9,  name: "Lácteos Frescos (Yogur)", p: 6.5, c: 4.0, f: 3.0, kcal: 69, unit: "g" },
            { id: 10, name: "Pescado Blanco y Mariscos", p: 19.5, c: 0.5, f: 2.0, kcal: 100, unit: "g" },
            { id: 11, name: "Pescado Azul / Conservas", p: 19.5, c: 0.5, f: 11.5, kcal: 180, unit: "g" },
            { id: 12, name: "Huevo (Unidad ~60g)", p: 6.5, c: 1.0, f: 7.5, kcal: 98, unit: "u" },   
            { id: 13, name: "Harinas y Cereales (Crudo)", p: 12.5, c: 63.0, f: 5.5, kcal: 350, unit: "g" },
            { id: 14, name: "Panes", p: 9.5, c: 47.5, f: 2.5, kcal: 250, unit: "g" },
            { id: 15, name: "Hidratos Cocidos (Pasta)", p: 4.0, c: 25.0, f: 0.5, kcal: 120, unit: "g" },
            { id: 16, name: "Frutas Frescas", p: 0.5, c: 12.0, f: 0.5, kcal: 55, unit: "g" },
            { id: 17, name: "Verduras y Hortalizas", p: 1.5, c: 6.0, f: 0.5, kcal: 35, unit: "g" },
            { id: 18, name: "Legumbres", p: 6.0, c: 12.0, f: 0.8, kcal: 79, unit: "g" },
            { id: 19, name: "Macro proteina", p: 100.0, c: 0.0, f: 0.0, kcal: 400, unit: "g" },
            { id: 20, name: "Macro carbohidrato", p: 0.0, c: 100.0, f: 0.0, kcal: 400, unit: "g" },
            { id: 21, name: "Macro grasa", p: 0.0, c: 0.0, f: 100.0, kcal: 900, unit: "g" },
            { id: 22, name: "Ñoquis (Gnocchi)", p: 3.5, c: 36.0, f: 0.5, kcal: 165, unit: "g" },
            { id: 23, name: "Tubérculos (Patata/Batata)", p: 2, c: 21.0, f: 0.2, kcal: 94, unit: "g" },
            // Propuestas Micro-unidades
            { id: 24, name: "Aceituna (Unidad ~4g)", p: 0.0, c: 0.0, f: 0.5, kcal: 6, unit: "u" },
            { id: 25, name: "Nuez (Grano ~5g)", p: 0.8, c: 0.7, f: 3.0, kcal: 33, unit: "u" },
            { id: 26, name: "Tomate Cherry (Unidad ~12g)", p: 0.1, c: 0.5, f: 0.0, kcal: 3, unit: "u" },
            // Propuestas Macro-unidades
            { id: 27, name: "Tomate Ensalada (Unidad ~150g)", p: 1.5, c: 5.5, f: 0.3, kcal: 30, unit: "u" },
            { id: 28, name: "Manzana (Media ~180g)", p: 0.5, c: 25.0, f: 0.5, kcal: 95, unit: "u" },
            // otros
            { id: 29, name: "Jamón Serrano", p: 33.5, c: 1.0, f: 12.2, kcal: 248, unit: "g" }
        ];

        let globalLog = []; 
        let chartInstance = null;
        let modalChartInstance = null;
        let selectedIds = new Set();

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            populateSelect();
            initDateInputs();
            // EVENTOS DE CAMBIO
            document.getElementById('foodSelect').addEventListener('change', updatePreview);
            // ESCUCHAR EN TIEMPO REAL LA ENTRADA DE CANTIDAD
            document.getElementById('amountInput').addEventListener('input', updatePreview); 
            
            setTodayFilter(); 
            updatePreview();
            updateDayLabels();
        });

        // --- ACTUALIZACIÓN DINÁMICA ---
        function updatePreview() {
            const select = document.getElementById('foodSelect');
            const amountInput = document.getElementById('amountInput'); // Capturamos input
            const foodId = parseInt(select.value);
            const food = foodData.find(f => f.id === foodId);
            
            if (food) {
                // Etiqueta unidad
                document.getElementById('amountLabel').textContent = food.unit === 'u' ? "Cantidad (unidades)" : "Cantidad (gramos)";
                
                // LÓGICA DE CÁLCULO PROPORCIONAL
                const amount = parseFloat(amountInput.value) || 0; // Si está vacío cuenta como 0
                const factor = food.unit === 'g' ? amount / 100 : amount;

                // Calculamos valores
                const p = (food.p * factor).toFixed(1);
                const c = (food.c * factor).toFixed(1);
                const f = (food.f * factor).toFixed(1);
                const k = Math.round(food.kcal * factor);

                // Mostramos HTML actualizado
                document.getElementById('previewData').innerHTML = `
                    <div class="flex flex-wrap gap-x-3 gap-y-1 font-mono text-blue-900 font-bold">
                        <span>P: ${p}</span> 
                        <span>HC: ${c}</span> 
                        <span>G: ${f}</span> 
                        <span class="text-red-600">Kcal: ${k}</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-1 italic">
                        (Valores calculados para ${amount}${food.unit}. Base: ${food.kcal}kcal/100${food.unit})
                    </div>
                `;
            }
        }

        // --- BÚSQUEDA API (SIN CAMBIOS) ---
        function handleEnter(e) { if(e.key === 'Enter') searchOnline(); }

        async function searchOnline() {
            const query = document.getElementById('apiSearchInput').value;
            if(!query || query.length < 3) return alert("Escribe al menos 3 caracteres.");
            const loader = document.getElementById('searchLoader');
            const icon = document.getElementById('searchIcon');
            const resultsDiv = document.getElementById('searchResults');
            
            loader.classList.remove('hidden'); icon.classList.add('hidden');
            resultsDiv.classList.add('hidden'); resultsDiv.innerHTML = '';

            try {
                const url = `https://es.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&fields=product_name,nutriments,id`;
                const response = await fetch(url);
                const data = await response.json();

                if(data.products && data.products.length > 0) {
                    let html = '<ul class="divide-y divide-gray-100">';
                    let found = false;
                    data.products.forEach(prod => {
                        if(prod.nutriments && (prod.nutriments['energy-kcal_100g'] !== undefined || prod.nutriments['energy-kcal'] !== undefined)) {
                            found = true;
                            const p = prod.nutriments['proteins_100g'] || 0;
                            const c = prod.nutriments['carbohydrates_100g'] || 0;
                            const f = prod.nutriments['fat_100g'] || 0;
                            const k = prod.nutriments['energy-kcal_100g'] || prod.nutriments['energy-kcal'] || 0;
                            const safeName = (prod.product_name || "Sin nombre").replace(/'/g, "");
                            html += `<li class="p-2 hover:bg-blue-50 cursor-pointer flex justify-between items-center group" onclick="selectApiItem('${safeName}', ${p}, ${c}, ${f}, ${k})"><span class="font-medium text-gray-700 truncate w-2/3">${prod.product_name}</span><span class="text-gray-400 text-[10px] group-hover:text-blue-600">${Math.round(k)} kcal/100g</span></li>`;
                        }
                    });
                    if(!found) html += '<li class="p-2 text-gray-500 italic">Sin info nutricional válida.</li>';
                    html += '</ul>';
                    resultsDiv.innerHTML = html; resultsDiv.classList.remove('hidden');
                } else { alert("Sin resultados."); }
            } catch (error) { console.error(error); alert("Error de conexión."); } finally { loader.classList.add('hidden'); icon.classList.remove('hidden'); }
        }

        function selectApiItem(name, p, c, f, kcal) {
            const newId = 1000 + foodData.length + Math.floor(Math.random() * 1000);
            foodData.push({ id: newId, name: `[WEB] ${name}`, p: Number(p), c: Number(c), f: Number(f), kcal: Number(kcal), unit: 'g' });
            populateSelect();
            const select = document.getElementById('foodSelect');
            select.value = newId;
            updatePreview(); // Actualizará con 100g por defecto
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('apiSearchInput').value = '';
        }

        // --- CORE & UI ---
        function initDateInputs() { document.getElementById('entryDate').value = new Date().toISOString().split('T')[0]; }
        function setTodayFilter() { const t = new Date().toISOString().split('T')[0]; document.getElementById('filterStart').value = t; document.getElementById('filterEnd').value = t; updateDayLabels(); applyFilter(); }
        function shiftDate(d) {
            const s = document.getElementById('filterStart').value, e = document.getElementById('filterEnd').value;
            if(!s) return;
            const add = (str, n) => { const dt = new Date(str); dt.setDate(dt.getDate()+n); return dt.toISOString().split('T')[0]; };
            document.getElementById('filterStart').value = add(s,d);
            document.getElementById('filterEnd').value = e ? add(e,d) : add(s,d);
            updateDayLabels(); applyFilter();
        }
        function updateDayLabels() {
            const d = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
            const l = (v) => v ? d[new Date(v).getDay()]+' '+new Date(v).getDate() : '';
            document.getElementById('labelStart').textContent = l(document.getElementById('filterStart').value);
            document.getElementById('labelEnd').textContent = l(document.getElementById('filterEnd').value);
        }

        function populateSelect() {
            const sel = document.getElementById('foodSelect');
            const val = sel.value; sel.innerHTML = '';
            [...foodData].sort((a,b)=>a.name.localeCompare(b.name)).forEach(f => {
                const o = document.createElement('option'); o.value = f.id; o.text = f.name; sel.appendChild(o);
            });
            if(val && [...sel.options].some(o => o.value == val)) sel.value = val;
        }

        function addItem() {
            const select = document.getElementById('foodSelect');
            const amountInput = document.getElementById('amountInput');
            const dateInput = document.getElementById('entryDate');
            const amount = parseFloat(amountInput.value);
            const foodId = parseInt(select.value);
            
            if (!amount || amount <= 0 || !dateInput.value) return alert("Revise datos.");

            const food = foodData.find(f => f.id === foodId);
            const factor = food.unit === 'g' ? amount / 100 : amount;

            globalLog.push({
                id: Date.now(),
                date: dateInput.value,
                foodId: food.id,
                foodName: food.name,
                amount: amount,
                unit: food.unit,
                p: parseFloat((food.p * factor).toFixed(1)),
                c: parseFloat((food.c * factor).toFixed(1)),
                f: parseFloat((food.f * factor).toFixed(1)),
                kcal: Math.round(food.kcal * factor)
            });
            saveData(); applyFilter();
        }

        function deleteItem(id) { if(confirm('¿Borrar?')) { globalLog = globalLog.filter(i => i.id !== id); selectedIds.delete(id); saveData(); applyFilter(); } }
        function resetApp() { if(confirm('¿BORRAR TODO?')) { localStorage.removeItem('macroCalculatorData'); globalLog = []; selectedIds.clear(); applyFilter(); } }

        // --- MODAL ---
        function toggleSelection(id) { selectedIds.has(id) ? selectedIds.delete(id) : selectedIds.add(id); updateFab(); }
        function toggleAll(src) { document.querySelectorAll('.row-checkbox').forEach(c => { c.checked = src.checked; const id = parseInt(c.dataset.id); src.checked ? selectedIds.add(id) : selectedIds.delete(id); }); updateFab(); }
        function updateFab() {
            const fab = document.getElementById('analyzeFab');
            if(selectedIds.size > 0) { fab.classList.remove('hidden'); fab.classList.add('flex'); document.getElementById('fabText').textContent = `Analizar (${selectedIds.size})`; }
            else { fab.classList.add('hidden'); fab.classList.remove('flex'); }
        }
        function analyzeSelection() {
            const items = globalLog.filter(i => selectedIds.has(i.id));
            if (!items.length) return;
            let p=0, c=0, f=0, k=0;
            const list = document.getElementById('modalList'); list.innerHTML='';
            items.forEach(i => {
                p+=i.p; c+=i.c; f+=i.f; k+=i.kcal;
                list.innerHTML += `<li class="flex justify-between border-b pb-1 last:border-0 border-gray-100"><span>${i.foodName}</span><span class="text-xs text-gray-500 font-mono">${i.amount}${i.unit}</span></li>`;
            });
            document.getElementById('modalP').textContent=p.toFixed(1);
            document.getElementById('modalC').textContent=c.toFixed(1);
            document.getElementById('modalF').textContent=f.toFixed(1);
            document.getElementById('modalKcal').textContent=k;
            const ctx = document.getElementById('modalChart').getContext('2d');
            if(modalChartInstance) modalChartInstance.destroy();
            const hasD = (p+c+f)>0;
            modalChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Prot','Carbs','Grasas'], datasets: [{ data: hasD?[p*4,c*4,f*9]:[1,1,1], backgroundColor: hasD?['#39f792','#eab308','#ef4444']:['#eee','#eee','#eee'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{position:'bottom'}} } });
            document.getElementById('detailModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }

        // --- DATA ---
        async function exportData() {
            if(!globalLog.length) return alert("Sin datos.");
            const f = new File([JSON.stringify(globalLog,null,2)], `backup_${new Date().toISOString().split('T')[0]}.json`, {type:"application/json"});
            if(navigator.canShare && navigator.canShare({files:[f]})) { try { await navigator.share({files:[f], title:'Backup Nutri'}); return; } catch(e){} }
            const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(globalLog,null,2)], {type:"application/json"})); a.download=f.name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function handleImport(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(Array.isArray(d) && confirm(`¿Importar ${d.length} registros?`)) { globalLog = d; saveData(); applyFilter(); alert("Hecho."); } } catch(err){ alert("Error archivo."); } input.value=''; }; r.readAsText(f);
        }
        function saveData() { localStorage.setItem('macroCalculatorData', JSON.stringify(globalLog)); }
        function loadData() { const s = localStorage.getItem('macroCalculatorData'); if(s) globalLog = JSON.parse(s); }
        function applyFilter() {
            const s = document.getElementById('filterStart').value, e = document.getElementById('filterEnd').value;
            let f = globalLog.sort((a,b)=>b.id-a.id);
            if(s && e) f = f.filter(i => i.date >= s && i.date <= e);
            selectedIds.clear(); updateFab(); renderTable(f); calcTotals(f);
        }
        function renderTable(items) {
            const tb = document.getElementById('foodTableBody'); tb.innerHTML='';
            if(!items.length) { tb.innerHTML='<tr><td colspan="9" class="p-8 text-center text-gray-400">Vacío</td></tr>'; return; }
            items.forEach(i => {
                const ck = selectedIds.has(i.id)?'checked':'';
                tb.innerHTML += `<tr class="hover:bg-gray-50 group transition-colors"><td class="p-3 text-center"><input type="checkbox" data-id="${i.id}" class="row-checkbox custom-checkbox rounded text-blue-600" onclick="toggleSelection(${i.id})" ${ck}></td><td class="p-3 whitespace-nowrap text-gray-600">${i.date}</td><td class="p-3 font-medium text-gray-900">${i.foodName}</td><td class="p-3 text-gray-500">${i.amount}${i.unit}</td><td class="p-3 text-right text-gray-700">${i.p}</td><td class="p-3 text-right text-gray-700">${i.c}</td><td class="p-3 text-right text-gray-700">${i.f}</td><td class="p-3 text-right font-bold text-gray-900">${i.kcal}</td><td class="p-3 text-center"><button onclick="deleteItem(${i.id})" class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100">&times;</button></td></tr>`;
            });
        }
        function calcTotals(items) {
            let p=0, c=0, f=0, k=0; items.forEach(i => { p+=i.p; c+=i.c; f+=i.f; k+=i.kcal; });
            ['summary','foot'].forEach(x => { document.getElementById(x+'Protein').textContent=p.toFixed(1); document.getElementById(x+'Carbs').textContent=c.toFixed(1); document.getElementById(x+'Fats').textContent=f.toFixed(1); document.getElementById(x+'Kcal').textContent=k; });
            const ctx = document.getElementById('macroChart').getContext('2d'); if(chartInstance) chartInstance.destroy();
            const h = (p+c+f)>0; chartInstance = new Chart(ctx, { type:'doughnut', data:{ labels:['Prot','Carbs','Grasas'], datasets:[{data:h?[p*4,c*4,f*9]:[1,1,1], backgroundColor:h?['#39f792','#eab308','#ef4444']:['#eee','#eee','#eee'], borderWidth:0}] }, options:{responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{legend:{position:'right',labels:{boxWidth:12}}}} });
        }
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('PWA ServiceWorker registrado con éxito: ', registration.scope);
                })
                .catch(err => {
                    console.log('Fallo al registrar el ServiceWorker: ', err);
                });
        });
    }
</script>
</body>
</html>
